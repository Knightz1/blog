---
layout: post
title: "PLAY ransomware"
categories: malware analysis
toc: true
---

## 1. SAMPLE: [Play ransomware](https://bazaar.abuse.ch/sample/006ae41910887f0811a3ba2868ef9576bbd265216554850112319af878f06e55/)

## 2. Anti static analysis

- Hàm main:

![image](https://user-images.githubusercontent.com/91442807/204834393-586fe8fb-17e7-4990-96db-8595406e63d8.png)

- Có vẻ IDA dịch không rõ lắm, xem lại asm:

![image](https://user-images.githubusercontent.com/91442807/204834819-179eb4a1-1dbc-45f8-80bb-e124cc2819aa.png)

![image](https://user-images.githubusercontent.com/91442807/204834894-0317a55b-496a-48e1-9d96-09d37e94f644.png)

- Có vẻ hàm lấy giá trị trên cùng của stack + 0x35 

- Note:

```
Khi chương trình gọi lệnh call một hàm thì giá trị trên cùng của stack sẽ lưu địa chỉ của instruction tiếp theo.
```

-> Có nghĩa lấy địa chỉ của `pop edi` là `0xD042F1` + `0x35`.

- Debug thử:

![image](https://user-images.githubusercontent.com/91442807/204836716-2f3b24b7-b81e-4227-a549-a479ce185eee.png)

![image](https://user-images.githubusercontent.com/91442807/204836858-2264ba06-0bc5-44e5-89b4-f1e99e0414d1.png)

-> Đúng là như vậy.

- Sau khi tính toán được giá trị mới thì chương trình nhảy đến địa chỉ đó luôn:

![image](https://user-images.githubusercontent.com/91442807/204837190-c7ab0a42-4101-4402-9c90-1a25788ca689.png)

-> Tới đây ta có thể patch lại bằng cách tự tính toán địa chỉ và thay thể lệnh `call` bằng `jump`.

![image](https://user-images.githubusercontent.com/91442807/204837969-7d35574a-5d7b-4458-b3f6-2a6313933aa4.png)

- Có thể dùng tool [keypatch](https://github.com/keystone-engine/keypatch#appendix-install-keystone-for-ida-pro) để patch lại cho dễ.

- Kéo tiếp xuống dưới lại gặp hàm tương tự nên ta cũng thực hiện tương tự cuối cùng có thể có thể decompile được hàm main:

![image](https://user-images.githubusercontent.com/91442807/204838795-463b5ca1-c6f2-4b31-964f-7b032c8c6391.png)

- Đi vào sâu trong hàm main nữa còn rất nhiều chỗ bị như vậy nên không thể patch lại bằng tay hết được.



